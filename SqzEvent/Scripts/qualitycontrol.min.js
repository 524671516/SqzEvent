var myApp = new Framework7({ modalTitle: '生产管理', pushState: true, modalButtonOk: "确定", modalButtonCancel: "取消", cache: false }); var $$ = Dom7; var mainView = myApp.addView('.view-main', { dynamicNavbar: true, }); $$(document).on("ajaxStart", function (e) {
    if (e.detail.xhr.requestUrl.indexOf("autocomplete-languages.json") >= 0) { return; }
    myApp.showIndicator();
}); $$(document).on("ajaxComplete", function (e) {
    if (e.detail.xhr.requestUrl.indexOf("autocomplete-languages.json") >= 0) { return; }
    myApp.hideIndicator();
}); wx.config({ debug: false, appId: $("#appId").text(), timestamp: $("#timeStamp").text(), nonceStr: $("#nonce").text(), signature: $("#signature").text(), jsApiList: ["uploadImage", "downloadImage", "chooseImage", "getLocation", "previewImage", "openLocation", "scanQRCode"] }); $$.ajax({ url: "/QualityControl/UserInfoPartial", type: "post", success: function (data) { $$("#userinfo").html(data); } }); updateHomeInfo(); var ptrContent = $$("#home-refresh"); ptrContent.on("refresh", function (e) { setTimeout(updateHomeInfo, 500); }); myApp.onPageInit('Home', function (page) { updateHomeInfo(); var ptrContent = $$("#home-refresh"); ptrContent.on("refresh", function (e) { setTimeout(updateHomeInfo, 500); }); })
myApp.onPageInit('qccheckin', function (page) {
    var $factoryselect = $("#factory-select")
    var $qccheckinsubmit = $("#qccheckin-submit"); var $qccheckinform = $('#qccheckin-form'); $qccheckinform.on("keyup", ".required", function () { $(this).attr("placeholder", "").removeClass("invalid-input"); }); $qccheckinform.validate({ debug: false, errorPlacement: function (error, element) { myApp.hideIndicator(); $qccheckinsubmit.prop("disabled", false).removeClass("color-gray"); }, errorClass: "invalid-input", submitHandler: function (form) { CheckError("qccheckin-submit", "qccheckin-form") } }); $qccheckinsubmit.on("click", function () { if (!$qccheckinsubmit.prop("disabled")) { $qccheckinsubmit.prop("disabled", true).addClass("color-gray"); setTimeout(function () { $qccheckinform.submit(); }, 500); } }); $factoryselect.on("change", function () {
        if ($("#FactoryId").val() != "") {
            $("#input-content").removeClass("hidden"); $$.ajax({
                url: "/QualityControl/QCCheckinPartial", data: { factoryId: $$("#FactoryId").val() }, success: function (data) {
                    $$("#template-content").html(data); $$.ajax({
                        url: "/QualityControl/CheckCheckinAjax", type: "post", data: { fid: $$("#FactoryId").val() }, success: function (checkdata) {
                            var checkdata = JSON.parse(checkdata); if (checkdata.result) {
                                myApp.alert("该工厂当天已有签到，重新签到将覆盖之前的记录"); $$.ajax({
                                    url: "/QualityControl/CheckinContent", data: { cid: checkdata.agendaId }, type: "post", success: function (contentdata) {
                                        var contentdata = JSON.parse(contentdata); if (contentdata.result == "SUCCESS") {
                                            $("#Photos").val(contentdata.photos); $("#CheckinRemark").val(contentdata.remark); for (var i = 0; i < contentdata.template.length; i++) { $("#" + contentdata.template[i].key).val(contentdata.template[i].value); }
                                            uploadCheckinFile("qccheckin-form", "qccheckin-photos", "Photos", "qccheckin-imgcount", 9); currentTextAreaLength("qccheckin-form", "CheckinRemark", 200, "qccheckin-currentlen");
                                        }
                                    }
                                });
                            }
                            else { $("#Photos").val(""); $("#CheckinRemark").val(""); uploadCheckinFile("qccheckin-form", "qccheckin-photos", "Photos", "qccheckin-imgcount", 9); currentTextAreaLength("qccheckin-form", "CheckinRemark", 200, "qccheckin-currentlen"); }
                        }
                    });
                }
            });
        }
        else { $("#input-content").addClass("hidden"); }
    });
}); myApp.onPageInit("addcheckout", function (page) {
    var $checkoutnoinfo = $("#checkout-noinfo"); var $checkout = $("#checkout"); var $addqccheckoutsubmit = $("#addqccheckout-submit"); $$("#AgendaId").on("change", function () { $$.ajax({ url: "/QualityControl/AddQCCheckoutPartial", data: { agendaId: $$("#AgendaId").val() }, success: function (data) { $$('#addcheckout-content').html(data); currentTextAreaLength("addqccheckout-form", "CheckoutRemark", 200, "qccheckout-currentlen"); } }); }); $checkout.on("keyup", ".required", function () { $(this).attr("placeholder", "").removeClass("invalid-input"); }); if ($$("#AgendaId").val() == "") { $addqccheckoutsubmit.prop("disabled", true).addClass("color-gray"); $checkoutnoinfo.append("<div  class=\"content-block-title\">无可签退项</div>"); } else { $$.ajax({ url: "/QualityControl/AddQCCheckoutPartial", data: { agendaId: $$("#AgendaId").val() }, success: function (data) { $$('#addcheckout-content').html(data); currentTextAreaLength("addqccheckout-form", "CheckoutRemark", 200, "qccheckout-currentlen"); } }); }
    $addqccheckoutsubmit.on("click", function () { if (!$addqccheckoutsubmit.prop("disabled")) { $addqccheckoutsubmit.prop("disabled", true).addClass("color-gray"); setTimeout(function () { CheckError("addqccheckout-submit", "addqccheckout-form"); }, 500) } });
}); myApp.onPageInit("factorytestlist", function (page) {
    if ($$("#SelectFactoryId").val() != "") { $$.ajax({ url: "/QualityControl/QualityFactoryTestPartial", data: { fid: $$("#SelectFactoryId").val() }, success: function (data) { $$("#factorytest-list").html(data); } }) }
    $$("#factorytestlist").on("change", "#SelectFactoryId", function () { if ($$("#SelectFactoryId").val() != "") { $$.ajax({ url: "/QualityControl/QualityFactoryTestPartial", data: { fid: $$("#SelectFactoryId").val() }, success: function (data) { $$("#factorytest-list").html(data); } }) } else { $$("#factorytest-list").html(""); } })
    $$("#factorytestlist").on("deleted", ".swipeout", function (e) { $$.ajax({ url: "/QualityControl/DeleteFactoryTest", data: { FtId: $$(e.target).find(".swipeout-delete").attr("data-url") }, method: "post", success: function (data) { data = JSON.parse(data); if (data.result != "SUCCESS") { myApp.alert("删除失败"); } } }); }); PhotoBrowser("factorytestlist");
})
myApp.onPageInit("breakdownlist", function (page) { var calendarMultiple = myApp.calendar({ input: "#breakdownlist-date", dateFormat: "yyyy-mm-dd", monthNames: monthNames, monthNamesShort: monthNamesShort, dayNames: dayNames, dayNamesShort: dayNamesShort, closeOnSelect: true }); $$.ajax({ url: "/QualityControl/BreakdownListPartial", data: { date: $$("#breakdownlist-date").val() }, success: function (data) { $$("#breakdownlist-content").html(data); } }); $$("#breakdownlist-date").on("change", function () { $$.ajax({ url: "/QualityControl/BreakdownListPartial", data: { date: $$("#breakdownlist-date").val() }, success: function (data) { $$("#breakdownlist-content").html(data); } }); }); }); myApp.onPageInit("qualityregulartest", function (page) {
    var calendarMultiple = myApp.calendar({ input: "#ApplyDate", dateFormat: "yyyy-mm-dd", monthNames: monthNames, monthNamesShort: monthNamesShort, dayNames: dayNames, dayNamesShort: dayNamesShort, closeOnSelect: true }); $$("#qualityregulartest-submit").on("click", function () { if (!$$("#qualityregulartest-submit").prop("disabled")) { $$("#qualityregulartest-submit").prop("disabled", true).addClass("color-gray"); setTimeout(function () { CheckError("qualityregulartest-submit", "qualityregulartest-form"); }, 500) } })
    $$("#qualityregulartest").on("change", "#FactoryId", function () {
        $$("#product-select").find(".item-after").html("- 请选择 -"); $$("#productclass-select").find(".item-after").html("- 请选择 -"); $("#ProductId").html("<option value=\"\">- 请选择 -</option>"); $("#ProductId").parent().find(".smart-select-value").html("- 请选择 -")
        $("#ProductClassId").html("<option value=\"\">- 请选择 -</option>"); $("#ProductClassId").parent().find(".smart-select-value").html("- 请选择 -")
        if ($$("#FactoryId").val() != "") {
            $$.ajax({
                url: "/QualityControl/RefreshQualityProductClassListAjax", type: "post", data: { factoryId: $$("#FactoryId").val(), }, success: function (data) {
                    $$("#ProductClassId").html("").append("<option value=\"\">- 请选择 -</option>")
                    var _data = JSON.parse(data); var _len = _data.content.length; if (_data.result == "SUCCESS") { for (var i = 0; i < _len; i++) { $$("#ProductClassId").append("<option value=\"" + _data.content[i].Id + "\">" + _data.content[i].Name + "</option>"); } }
                }
            })
        }
    })
    $$("#qualityregulartest").on("change", "#ProductClassId", function () {
        $$("#product-select").find(".item-after").html("- 请选择 -"); $("#ProductId").html("<option value=\"\">- 请选择 -</option>"); $("#ProductId").parent().find(".smart-select-value").html("- 请选择 -")
        if ($$("#ProductClassId").val() != "") {
            $$.ajax({
                url: "/QualityControl/RefreshQualityTestProductListAjax", type: "post", data: { factoryId: $$("#FactoryId").val(), productclassId: $$("#ProductClassId").val() }, success: function (data) {
                    $$("#ProductId").html("").append("<option value=\"\">- 请选择 -</option>")
                    var _data = JSON.parse(data); var _len = _data.content.length; if (_data.result == "SUCCESS") { for (var i = 0; i < _len; i++) { $$("#ProductId").append("<option value=\"" + _data.content[i].Id + "\">" + _data.content[i].Name + "</option>"); } }
                }
            })
        }
    })
    uploadCheckinFile("qualityregulartest-form", "qualityregulartest-photos", "Photo", "qualityregulartest-imgcount", 3);
})
myApp.onPageInit("addbreakdown", function (page) {
    var _date = new Date(); var hor = (_date.getHours() < 10) ? "0" + _date.getHours().toString() : _date.getHours().toString(); var min = (_date.getMinutes() < 10) ? "0" + _date.getMinutes().toString() : _date.getMinutes().toString(); var realmin = min[0] + (min[1] < 5 ? 0 : 5); var $equipmentselect = $("#equipment-select")
    var $factoryselect = $("#factory-select")
    var $addbreakdownsubmit = $("#addbreakdown-submit"); var $addbreakdownform = $('#addbreakdown-form'); var pickerInline = myApp.picker({ input: '#BreakDownTimeTiny', formatValue: function (p, values, displayValues) { return values[0] + ':' + values[1]; }, toolbarCloseText: "关闭", value: [hor, realmin], cols: time_col }); $factoryselect.on("change", function () {
        $$("#QCEquipmentId").html(""); $$("#QCEquipmentId").append("<option>- 请选择 -</option>"); $$("#BreakDownTypeId").html(""); $$("#BreakDownTypeId").append("<option>- 请选择 -</option>"); $$("#QCEquipmentId").val(""); $$("#BreakDownTypeId").val(""); $$("#equipment-select .item-after").text("- 请选择 -"); $$("#breakdowntype-select .item-after").text("- 请选择 -"); if ($$("#FactoryId").val() != "") {
            $$.ajax({
                url: "/QualityControl/RefreshEquipmentListAjax", data: { factoryId: $("#FactoryId").val() }, type: "post", success: function (data) {
                    data = JSON.parse(data); if (data.result == "SUCCESS") {
                        for (var i = 0; i < data.content.length; i++) { $$("#QCEquipmentId").append("<option value=\"" + data.content[i].Id + "\">" + data.content[i].Name + "</option>"); }
                        $("#QCEquipmentLi").removeClass("hidden");
                    }
                }
            });
        } else { $("#BreakDownTypeLi").addClass("hidden"); $("#QCEquipmentLi").addClass("hidden"); }
    }); $equipmentselect.on("change", function () {
        $$("#BreakDownTypeId").html(""); $$("#BreakDownTypeId").append("<option>- 请选择 -</option>"); $$("#BreakDownTypeId").val(""); $$("#breakdowntype-select .item-after").text("- 请选择 -"); if ($$("#QCEquipmentId").val() != "" && $$("#QCEquipmentId").val() != "- 请选择 -") {
            $$.ajax({
                url: "/QualityControl/RefreshBreakdownTypeListAjax", data: { equipmentId: $("#QCEquipmentId").val() }, type: "post", success: function (data) {
                    data = JSON.parse(data); if (data.result == "SUCCESS") {
                        for (var i = 0; i < data.content.length; i++) { $$("#BreakDownTypeId").append("<option value=\"" + data.content[i].Id + "\">" + data.content[i].Name + "</option>"); }
                        $("#BreakDownTypeLi").removeClass("hidden");
                    }
                }
            });
        } else { $("#BreakDownTypeLi").addClass("hidden"); }
    }); $addbreakdownform.validate({ debug: false, errorPlacement: function (error, element) { myApp.hideIndicator(); $addbreakdownsubmit.prop("disabled", false).removeClass("color-gray"); }, errorClass: "invalid-input", submitHandler: function (form) { CheckError("addbreakdown-submit", "addbreakdown-form") } }); $addbreakdownsubmit.on("click", function () { if (!$addbreakdownsubmit.prop("disabled")) { $addbreakdownsubmit.prop("disabled", true).addClass("color-gray"); setTimeout(function () { $addbreakdownform.submit(); }, 500); } }); uploadCheckinFile("addbreakdown-form", "addbreakdown-photos", "Photos", "addbreakdown-imgcount", 7); currentTextAreaLength("addbreakdown-form", "ReportContent", 200, "addbreakdown-currentlen");
}); myApp.onPageInit('dailysummary', function (page) {
    var $checkoutnoinfo = $("#checkout-noinfo"); var $dailysummary = $("#dailysummary"); var $dailysummarysubmit = $("#dailysummary-submit"); if ($$("#AgendaId").val() == "") { $dailysummarysubmit.prop("disabled", true).addClass("color-gray"); $checkoutnoinfo.append("<div  class=\"content-block-title\">无内容</div>"); } else { $$.ajax({ url: "/QualityControl/QCDailySummaryPartial", data: { agendaId: $$("#AgendaId").val() }, success: function (data) { $$('#dailysummary-content').html(data); uploadCheckinFile("qcdailysummarypartial-form", "qcsummary-photos", "SummaryPhotos", "qcsummary-imgcount", 7); currentTextAreaLength("qcdailysummarypartial-form", "Remark", 200, "qccheckin-currentlen"); } }); }
    $dailysummary.on("keyup", ".required", function () { $(this).attr("placeholder", "").removeClass("invalid-input"); }); $dailysummarysubmit.on("click", function () { if (!$dailysummarysubmit.prop("disabled")) { $dailysummarysubmit.prop("disabled", true).addClass("color-gray"); setTimeout(function () { CheckError("dailysummary-submit", "qcdailysummarypartial-form") }, 500) } }); $$("#AgendaId").on("change", function () { $$.ajax({ url: "/QualityControl/QCDailySummaryPartial", data: { agendaId: $$("#AgendaId").val() }, success: function (data) { $$('#dailysummary-content').html(data); uploadCheckinFile("qcdailysummarypartial-form", "qcsummary-photos", "SummaryPhotos", "qcsummary-imgcount", 7); currentTextAreaLength("qcdailysummarypartial-form", "Remark", 200, "qccheckin-currentlen"); } }); });
}); myApp.onPageInit('recoverybreakdown', function (page) { var $recoverybreakdownsubmit = $("#recoverybreakdown-submit"); var $recoveybreakdownform = $('#recoverybreakdown-form'); var pickerInline = myApp.picker({ input: '#RecoveryTimeTiny', formatValue: function (p, values, displayValues) { return values[0] + ':' + values[1]; }, toolbarCloseText: "关闭", value: ["10", "00"], cols: time_col }); $recoveybreakdownform.validate({ debug: false, errorPlacement: function (error, element) { myApp.hideIndicator(); $recoverybreakdownsubmit.prop("disabled", false).removeClass("color-gray"); }, errorClass: "invalid-input", submitHandler: function (form) { $recoveybreakdownform.ajaxSubmit(function (data) { CheckError("recoverybreakdown-submit", "recoverybreakdown-form") }); } }); $recoverybreakdownsubmit.on("click", function () { if (!$recoverybreakdownsubmit.prop("disabled")) { myApp.showIndicator(); $recoverybreakdownsubmit.prop("disabled", true).addClass("color-gray"); setTimeout(function () { $recoveybreakdownform.submit(); }, 500); } }); currentTextAreaLength("recoverybreakdown-form", "RecoveryRemark", 200, "recoverybreakdown-currentlen"); PhotoBrowser("recoverybreakdown"); }); myApp.onPageInit("productionplan", function (page) { var today = new Date(); var currentYear = today.getFullYear(); var currentMonth = (today.getMonth() + 1) < 10 ? "0" + (today.getMonth() + 1) : (today.getMonth() + 1); var pickerInline = myApp.picker({ input: '#productionplan-date', formatValue: function (p, values, displayValues) { return values[0] + '-' + values[1]; }, toolbarCloseText: "关闭", value: [currentYear, currentMonth], cols: time_col2 }); $$.ajax({ url: "/QualityControl/ProductPlanPartial", data: { date: $$("#productionplan-date").val() }, success: function (data) { $$("#productionplan-content").html(data); } }); $$("#productionplan-date").on("change", function () { $$.ajax({ url: "/QualityControl/ProductPlanPartial", data: { date: $$("#productionplan-date").val() }, success: function (data) { $$("#productionplan-content").html(data); } }); }); }); $$(document).on('pageAfterAnimation', '.page[data-page="qualitytestlist"]', function (e) { $$.ajax({ url: "/QualityControl/QualityTestListPartial", data: { date: $$("#qualitytestlist-date").val() }, success: function (data) { $$("#qualitytestlist-content").html(data); } }); })
myApp.onPageInit("qualitytestlist", function (page) { var calendarMultiple = myApp.calendar({ input: "#qualitytestlist-date", dateFormat: "yyyy-mm-dd", monthNames: monthNames, monthNamesShort: monthNamesShort, dayNames: dayNames, dayNamesShort: dayNamesShort, closeOnSelect: true }); $$("#qualitytestlist-date").on("change", function () { $$.ajax({ url: "/QualityControl/QualityTestListPartial", data: { date: $$("#qualitytestlist-date").val() }, success: function (data) { $$("#qualitytestlist-content").html(data); } }); }); $$("#qualitytestlist-content").on("deleted", ".swipeout", function (e) { $$.ajax({ url: "/QualityControl/DeleteQualityTest", data: { qtId: $$(e.target).attr("data-url") }, method: "post", success: function (data) { data = JSON.parse(data); if (data.result != "SUCCESS") { myApp.alert("删除失败"); } } }); }); }); myApp.onPageInit("addqualitytest", function (page) {
    var $addqualitytestform = $("#addqualitytest-form"); var $addqualitytestsubmit = $("#addqualitytest-submit"); $addqualitytestform.validate({ debug: false, errorPlacement: function (error, element) { myApp.hideIndicator(); $addqualitytestsubmit.prop("disabled", false).removeClass("color-gray"); }, errorClass: "invalid-input", submitHandler: function (form) { var nophotoarry = []; var pass = false; $(".one_photo").each(function () { if ($(this).val() == "") { nophotoarry.push($(this).parents(".accordion-item").find(".item-title").html()) } else { pass = true; } }); if (pass) { CheckError("addqualitytest-submit", "addqualitytest-form"); } else { if (nophotoarry.length > 0) { $addqualitytestsubmit.prop("disabled", false).removeClass("color-gray"); myApp.alert(nophotoarry[0] + "需要添加图片") } else { CheckError("addqualitytest-submit", "addqualitytest-form"); } } } }); $$("#FactoryId").on("change", function () {
        $addqualitytestsubmit.prop("disabled", true).addClass("color-gray"); $$("#list-type-template").html(""); $$("#list-type-template").addClass("hidden"); $("#productli").addClass("hidden")
        $("#productclassli").addClass("hidden")
        $("#ProductId").html("<option value=\"\">- 请选择 -</option>"); $("#ProductId").parent().find(".smart-select-value").html("- 请选择 -")
        $("#ProductClassId").html("<option value=\"\">- 请选择 -</option>"); $("#ProductClassId").parent().find(".smart-select-value").html("- 请选择 -")
        if ($$("#FactoryId").val() != "") {
            $$.ajax({
                url: "/QualityControl/RefreshQualityProductClassListAjax", type: "post", data: { factoryId: $$("#FactoryId").val(), }, success: function (data) {
                    $$("#ProductClassId").html("").append("<option value=\"\">- 请选择 -</option>")
                    var _data = JSON.parse(data); var _len = _data.content.length; if (_data.result == "SUCCESS") {
                        for (var i = 0; i < _len; i++) { $$("#ProductClassId").append("<option value=\"" + _data.content[i].Id + "\">" + _data.content[i].Name + "</option>"); }
                        $("#productclassli").removeClass("hidden")
                    }
                }
            })
        }
    })
    $$("#ProductClassId").on("change", function () {
        $addqualitytestsubmit.prop("disabled", true).addClass("color-gray"); $$("#list-type-template").html(""); $$("#list-type-template").addClass("hidden"); $("#productli").addClass("hidden")
        $("#ProductId").html("<option value=\"\">- 请选择 -</option>"); $("#ProductId").parent().find(".smart-select-value").html("- 请选择 -")
        if ($$("#ProductClassId").val() != "") {
            $$.ajax({
                url: "/QualityControl/RefreshQualityTestProductListAjax", type: "post", data: { factoryId: $$("#FactoryId").val(), productclassId: $$("#ProductClassId").val() }, success: function (data) {
                    $$("#ProductId").html("").append("<option value=\"\">- 请选择 -</option>")
                    var _data = JSON.parse(data); var _len = _data.content.length; if (_data.result == "SUCCESS") {
                        for (var i = 0; i < _len; i++) { $$("#ProductId").append("<option value=\"" + _data.content[i].Id + "\">" + _data.content[i].Name + "</option>"); }
                        $("#productli").removeClass("hidden");
                    }
                }
            })
        }
    })
    $$("#ProductId").on("change", function () { $$("#tempalate-content").html(""); if ($("#ProductId").val() != "") { $$.ajax({ url: "/QualityControl/AddQualityTestPartial", data: { pid: $$("#ProductId").val(), }, success: function (data) { $$("#list-type-template").html(data); $$("#list-type-template").removeClass("hidden"); $addqualitytestsubmit.prop("disabled", false).removeClass("color-gray"); uploadCheckinFile("addqualitytest-form", "addqualitytest-photos", "Photos", "addqualitytest-imgcount", 9); currentTextAreaLength("addqualitytest", "Remark", 200, "qctest-currentlen"); $(".one_photo").each(function () { var pid = $(this).attr("Id"); var uid = $(this).parent().parent().find("ul").attr("Id"); var countid = $(this).parent().parent().parent().parent().find("abbr").attr("Id"); uploadCheckinFile("addqualitytest-form", uid, pid, countid, 5); }); $(".item-after").on("click", function () { var _self = $(this).parent().parent().parent().parent(); myApp.confirm("是否确认删除此检测项", "提示", function () { _self.remove(); }); return false; }) }, error: function (data) { myApp.alert("请求失败。") } }) } })
    $addqualitytestform.on("click", ".scan-input", function () { var $input = $$(this); wx.scanQRCode({ needResult: 1, scanType: ["barCode"], success: function (res) { var result = res.resultStr; var _result = result.toString().substr(result.toString().lastIndexOf(",") + 1); $input.val(_result); } }); }); $addqualitytestsubmit.on("click", function () { if (!$addqualitytestsubmit.hasClass("color-gray")) { $addqualitytestsubmit.prop("disabled", true).addClass("color-gray"); setTimeout(function () { $addqualitytestform.submit(); }, 500); } });
}); myApp.onPageInit("breakdowndetails", function (page) { PhotoBrowser("breakdowndetails"); })
myApp.onPageInit("qualitytestdetails", function (page) {
    $("#qualitytestdetails").on("click", ".scan-input", function () { var $input = $$(this); wx.scanQRCode({ needResult: 1, scanType: ["barCode"], success: function (res) { var result = res.resultStr; var _result = result.toString().substr(result.toString().lastIndexOf(",") + 1); $input.val(_result); } }); }); $(".one_photo").each(function () { var pid = $(this).attr("Id"); var uid = $(this).parent().parent().find("ul").attr("Id"); var countid = $(this).parent().parent().parent().parent().find("abbr").attr("Id"); uploadCheckinFile("addqualitytest-form", uid, pid, countid, 5); })
    PhotoBrowser("qualitytestdetails"); $("#edit-qt").on("click", function () { if (!$(this).hasClass("color-gray")) { $(this).prop("disabled", true).addClass("color-gray"); var nophotoarry = []; var pass = false; $(".one_photo").each(function () { if ($(this).val() == "") { nophotoarry.push($(this).parents(".accordion-item").find(".item-title").html()) } else { pass = true; } }); if (pass) { $("#edit-qt-form").ajaxSubmit(function (data) { if (data.result == "SUCCESS") { mainView.router.back(); myApp.addNotification({ title: "通知", message: "表单修改成功" }); setTimeout(function () { myApp.closeNotification(".notifications"); }, 2e3); } else { mainView.router.back(); myApp.addNotification({ title: "通知", message: "表单修改失败" }); $("#edit-qt").prop("disabled", false).removeClass("color-gray"); setTimeout(function () { myApp.closeNotification(".notifications"); }, 2e3); } }); } else { if (nophotoarry.length > 0) { $("#edit-qt").prop("disabled", false).removeClass("color-gray"); myApp.alert(nophotoarry[0] + "需要添加图片") } else { $("#edit-qt-form").ajaxSubmit(function (data) { if (data.result == "SUCCESS") { mainView.router.back(); myApp.addNotification({ title: "通知", message: "表单修改成功" }); setTimeout(function () { myApp.closeNotification(".notifications"); }, 2e3); } else { mainView.router.back(); myApp.addNotification({ title: "通知", message: "表单修改失败" }); $("#edit-qt").prop("disabled", false).removeClass("color-gray"); setTimeout(function () { myApp.closeNotification(".notifications"); }, 2e3); } }); } } } })
})
function updateHomeInfo() {
    $$.ajax({
        url: "/QualityControl/HomeInfoAjax", type: "post", success: function (data) {
            var data = JSON.parse(data); if (data.result == "SUCCESS") {
                if (data.qt_dot)
                    $$("#qt_dot").removeClass("hidden"); else
                    $$("#qt_dot").addClass("hidden"); if (data.bd_dot)
                        $$("#bd_dot").removeClass("hidden"); else
                        $$("#bd_dot").addClass("hidden"); $$("#bd_count").text(data.bd_count); $$("#qt_count").text(data.qt_count); if (data.checkout_cnt != 0)
                            $$("#checkout_dot").removeClass("hidden"); else
                            $$("#checkout_dot").addClass("hidden"); if (data.summary_cnt != 0)
                                $$("#summary_dot").removeClass("hidden"); else
                                $$("#summary_dot").addClass("hidden"); $$("#checkout_cnt").text(data.checkout_cnt); $$("#summary_cnt").text(data.summary_cnt); $$("#datecode").text(data.datecode); myApp.pullToRefreshDone();
            }
        }
    });
}
function PhotoBrowser(pagename) {
    $$("#" + pagename).on("click", ".qc-photos", function () {
        var photos = $(this).attr("data-photos"); if (photos.trim() != "") {
            var images = photos.split(","); for (var i = 0; i < images.length; i++) { images[i] = "https://cdn2.shouquanzhai.cn/qc-img/" + images[i]; }
            var myPhotoBrowser = myApp.photoBrowser({ zoom: 500, photos: images, theme: 'dark', backLinkText: '关闭', toolbar: false, ofText: '/' }); myPhotoBrowser.open();
        } else { myApp.alert("没有找到图片"); }
    });
}
function uploadImage(img_id, img_filename) {
    $$("#" + img_id).on("click", function () {
        myApp.showIndicator(); setTimeout(function () { if (!img_success) { myApp.hideIndicator(); myApp.alert("上传图片失败"); } }, 2000); var localIds
        wx.chooseImage({
            count: 1, sizeType: ['compressed'], sourceType: ['album', 'camera'], success: function (res) {
                localIds = res.localIds; wx.uploadImage({
                    localId: localIds[0], isShowProgressTips: 1, success: function (res) {
                        var serverId = res.serverId; var img_success = false; $.ajax({
                            url: "/QualityControl/SaveOrignalImage", type: "post", data: { serverId: serverId }, success: function (data) {
                                if (data.result == "SUCCESS") { img_success = true; $$("#" + img_id).find(".item-title").children("i").remove(); $$("#" + img_id).find(".item-title").prepend("<i class='fa fa-check-circle color-green' aria-hidden='true'></i>"); $$("#" + img_id).find(".item-after").text("图片上传成功"); $$("#" + img_filename).val(data.filename); myApp.hideIndicator(); }
                                else { myApp.alert("上传失败，请重试"); }
                            }
                        });
                    }
                });
            }, cancel: function () { myApp.hideIndicator(); }
        });
    });
}
function uploadCheckinFile(pagename, imglist, photolist_id, current_count, max_count) {
    $$("#" + imglist).html(""); var photolist = splitArray($$("#" + photolist_id).val()); $$("#" + current_count).text(photolist.length); for (var i = 0; i < photolist.length; i++) { $$("#" + imglist).append("<li><div class=\"rep-imgitem\" data-rel=\"" + photolist[i] + "\" style=\"background-image:url(/QualityControl/ThumbnailImage?filename=" + photolist[i] + "); background-size:cover\"></div></li>"); }
    $$("#" + imglist).append('<li><a href="javascript:;" class="rep-imgitem-btn" id="' + imglist + '-upload-btn"><i class="fa fa-plus"></i></a></li>'); $$("#" + imglist).on("click", "#" + imglist + "-upload-btn", function (e) { var localIds; var photolist = splitArray($("#" + photolist_id).val()); if (photolist.length < max_count) { wx.chooseImage({ count: max_count - photolist.length, sizeType: ["compressed"], sourceType: ["album", "camera"], success: function (res) { localIds = res.localIds; upload_img(localIds, 0, photolist); } }); } else { myApp.alert("上传图片不得大于" + max_count + "张，无法添加"); } }); function upload_img(localIds, arraycount, pl) {
        if (arraycount < localIds.length) {
            wx.uploadImage({
                localId: localIds[arraycount], isShowProgressTips: 1, success: function (res) {
                    var serverId = res.serverId; $$.ajax({
                        url: "/QualityControl/SaveOrignalImage", type: "post", data: { serverId: serverId }, success: function (data) {
                            data = JSON.parse(data); if (data.result == "SUCCESS") { pl.push(data.filename); arraycount++; upload_img(localIds, arraycount, pl); }
                            else { myApp.alert("上传失败"); }
                        }
                    });
                }
            });
        }
        else {
            $$("#" + imglist).html(""); $$("#" + current_count).text(pl.length); $$("#" + photolist_id).val(pl.toString()); for (var i = 0; i < pl.length; i++) { $$("#" + imglist).append('<li><div class="rep-imgitem" data-rel=\'' + pl[i] + "' style=\"background-image:url(/QualityControl/ThumbnailImage?filename=" + pl[i] + '); background-size:cover"></div></li>'); }
            $$("#" + imglist).append('<li><a href="javascript:;" class="rep-imgitem-btn" id="' + imglist + '-upload-btn"><i class="fa fa-plus"></i></a></li>'); myApp.hideIndicator();
        }
    }
    $$("#" + imglist).on("click", ".rep-imgitem", function (e) { var img_item = $$(this); $$(".rep-imgitem").each(function () { $$(this).html(""); }); img_item.html("<div class='rep-imgitem-selected'><i class='fa fa-minus'></i></div>"); }); $$("#" + imglist).on("click", ".rep-imgitem-selected", function () {
        myApp.confirm("是否确认删除已上传图片?", "提示", function () {
            var delete_item = $(".rep-imgitem-selected").closest(".rep-imgitem").attr("data-rel"); var arraylist = splitArray($("#" + photolist_id).val()); var pos = $.inArray(delete_item, arraylist); arraylist.splice(pos, 1); $$("#" + photolist_id).val(arraylist.toString()); $$("#" + current_count).text(arraylist.length); $$("#" + imglist).html(""); for (var i = 0; i < arraylist.length; i++) { $("#" + imglist).append('<li><div class="rep-imgitem" data-rel=\'' + arraylist[i] + "' style=\"background-image:url(/QualityControl/ThumbnailImage?filename=" + arraylist[i] + '); background-size:cover"></div></li>'); }
            $$("#" + imglist).append('<li><a href="javascript:;" class="rep-imgitem-btn" id="' + imglist + '-upload-btn"><i class="fa fa-plus"></i></a></li>');
        });
    });
}
function isPInt(str) {
    if (!isNaN(str)) {
        if (str >= 0 && str != "")
            return true;
    } else { return false; }
}
function splitArray(value) {
    var list = new Array(); if (value != null) { if (value.trim() != "") { list = value.trim().split(","); return list; } }
    return list;
}
function currentTextAreaLength(pagename, id_name, max_length, result_id) { var tl_c = $$("#" + id_name).val().length; $$("#" + result_id).text(tl_c); $$("#" + pagename).on("change", "#" + id_name, function () { var tl = $$("#" + id_name).val().length; if (tl < max_length) { $$("#" + result_id).text(tl); } else { myApp.alert("已超出最大值，请重新填写或删除部分信息"); var str = $$("#" + id_name).val(); $$("#" + id_name).val(str.slice(0, 50)); $$("#" + result_id).text(max_length); } }); }
var time_col2 = [{
    values: (function () {
        var arr = []; for (var i = 1999; i <= 2030; i++) { arr.push(i); }
        return arr;
    })(),
}, { divider: true, content: '-' }, { values: ('01 02 03 04 05 06 07 08 09 10 11 12').split(' '), textAlign: 'right' }, ]
var time_col = [{
    values: (function () {
        var arr = []; for (var i = 0; i <= 23; i++) { arr.push(i < 10 ? '0' + i : i); }
        return arr;
    })(),
}, { divider: true, content: ':' }, {
    values: (function () {
        var arr = []; for (var i = 0; i <= 59; i = i + 5) { arr.push(i < 10 ? '0' + i : i); }
        return arr;
    })(),
}]
var monthNames = ["一月份", "二月份", "三月份", "四月份", "五月份", "六月份", "七月份", "八月份", "九月份", "十月份", "十一月份", "十二月份"]; var monthNamesShort = ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"]; var dayNames = ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"]; var dayNames = ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"]; var dayNamesShort = ["日", "一", "二", "三", "四", "五", "六"]; function CheckError(SubmitBtn, SubmitForm) {
    var pass = true; $("input.required").each(function () { if ($(this).val() == "") { $(this).attr("placeholder", "请输入信息").addClass("invalid-input"); pass = false; } else { $(this).removeClass("invalid-input"); } }); $("input.isnumber").each(function () { if ($(this).val() != "") { if (!isPInt($(this).val())) { $(this).attr("placeholder", "请输入合法数字").addClass("invalid-input"); pass = false; } } else { $(this).val("0"); } }); $("textarea.required").each(function () { if ($(this).val() == "") { $(this).attr("placeholder", "请输入备注信息").addClass("invalid-input"); pass = false; } }); $("textarea.maxlength_200").each(function () { if ($(this).length > 200) { $(this).attr("placeholder", "超过字数").addClass("invalid-input"); pass = false; } }); if (pass) { $("select.required").each(function () { if ($(this).val() == "- 请选择 -" || $(this).val() == null || $(this).val() == "") { myApp.alert($(this).next().find(".item-title").html() + " 未选择"); pass = false; } }); }
    if (pass) { $(".photos").each(function () { var photoList = splitArray($(this).val()); if (photoList.length == 0) { myApp.alert("至少上传一张照片"); pass = false; } }); }
    if (pass) {
        $("#" + SubmitBtn).prop("disabled", true).addClass("color-gray"); myApp.showIndicator(); setTimeout(function () {
            $("#" + SubmitForm).ajaxSubmit(function (data) {
                if (data == "SUCCESS") { myApp.hideIndicator(); mainView.router.back(); myApp.addNotification({ title: "通知", message: "表单提交成功" }); setTimeout(function () { myApp.closeNotification(".notifications"); }, 2e3); }
                else if (data == "MODIFIED" || data == "FAIL") {
                    if (data == "MODIFIED") { myApp.hideIndicator(); mainView.router.back(); myApp.addNotification({ title: "通知", message: "表单修改成功" }); } else { myApp.hideIndicator(); mainView.router.back(); myApp.addNotification({ title: "通知", message: "故障修复成功" }); }
                    setTimeout(function () { myApp.closeNotification(".notifications"); }, 2e3);
                }
                else { myApp.hideIndicator(); myApp.addNotification({ title: "通知", message: "表单提交失败" }); $("#" + SubmitBtn).prop("disabled", false).removeClass("color-gray"); setTimeout(function () { myApp.closeNotification(".notifications"); }, 2e3); }
            });
        }, 500)
    } else { $("#" + SubmitBtn).prop("disabled", false).removeClass("color-gray"); }
}